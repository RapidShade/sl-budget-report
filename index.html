<!DOCTYPE html>
<html>
<head>
    <title>Event PDF Budget Report Widget</title>
    <meta charset="utf-8">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            color: #333;
            margin: 0;
            padding: 20px;
            background-color: #f8f8f8;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            box-sizing: border-box;
            text-align: center;
        }
        .container {
            text-align: center;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
        }
        h2 {
            color: #2c3e50;
            margin-bottom: 20px;
        }
        p {
            font-size: 1em;
            color: #666;
            margin-bottom: 25px;
        }
        button {
            background-color: #4CAF50; /* Grist-like green */
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        #record-info {
            margin-top: 15px;
            font-size: 0.9em;
            color: #555;
            min-height: 20px; /* To prevent layout shift */
        }
        .error-message {
            color: red;
            background-color: #ffe0e0;
            border: 1px solid red;
            padding: 10px;
            margin-top: 20px;
            border-radius: 5px;
        }
    </style>
    <!-- Load pdf-lib and its fontkit extension -->
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit/dist/fontkit.umd.min.js"></script>
    <!-- This is the Grist plugin API script provided in your original file -->
    <script src="https://sportsledger.koe.org.gr/grist-plugin-api.js"></script>
</head>
<body>
    <div class="container" id="widget-container">
        <h2>Event PDF Budget Report</h2>
        <p id="message">Connecting to Grist... Please select a record.</p>
        <button id="downloadPdfButton" style="display: none;" disabled>Download PDF Report</button>
        <button id="debugButton" disabled>Debug Record Fetch</button>
        <div id="record-info"></div>
    </div>

    <script>
        console.log("[WIDGET] v5.2 Starting");

        // Ensure pdf-lib and fontkit are loaded
        if (typeof PDFLib === 'undefined' || typeof fontkit === 'undefined') {
            document.getElementById('widget-container').innerHTML = '<div class="error-message">Error: PDF Libraries not loaded.</div>';
            throw new Error("PDF-Lib or fontkit not found.");
        }

        const { PDFDocument, rgb } = PDFLib;
        const messageElement = document.getElementById('message');
        const downloadPdfButton = document.getElementById('downloadPdfButton');
        const debugButton = document.getElementById('debugButton');
        const recordInfoElement = document.getElementById('record-info');
        let currentRecord = null;

        /**
         * Updates the UI based on whether a record is selected.
         * @param {object|null} record - The Grist record object, or null if none is selected.
         */
        function updateUI(record) {
            currentRecord = record;
            if (record && Object.keys(record).length > 0) {
                console.log("[WIDGET] Record selected:", record);
                messageElement.style.display = 'none';
                downloadPdfButton.style.display = 'inline-block';
                downloadPdfButton.disabled = false;
                recordInfoElement.textContent = `Selected: ${record.Name || record.EventCode || 'Unnamed Event'}`;
            } else {
                console.log("[WIDGET] No record selected.");
                currentRecord = null;
                messageElement.style.display = 'block';
                messageElement.textContent = "Please select a record in the table.";
                downloadPdfButton.style.display = 'none';
                downloadPdfButton.disabled = true;
                recordInfoElement.textContent = '';
            }
        }

        /**
         * Formats a date value (timestamp or string) into YYYY-MM-DD format.
         * @param {number|string} dateInput - The date value from Grist.
         * @returns {string} The formatted date string or 'N/A'.
         */
        function formatDate(dateInput) {
            if (!dateInput) return 'N/A';
            // Grist sends dates as seconds-since-epoch timestamps
            const date = new Date(dateInput * 1000);
            if (isNaN(date.getTime())) return 'Invalid Date';
            return date.toISOString().split('T')[0];
        }

        /**
         * Generates and triggers the download of a PDF report for the current record.
         */
        async function generatePdfReport() {
            if (!currentRecord) {
                console.warn("[WIDGET] No record selected for PDF generation.");
                alert("Please select a record first.");
                return;
            }

            console.log("[WIDGET] Generating PDF for record ID:", currentRecord.id);
            downloadPdfButton.disabled = true;
            downloadPdfButton.textContent = 'Generating...';

            try {
                // Fetch fonts that support Unicode (including Greek characters)
                const fontUrl = 'https://pdf-lib.js.org/assets/ubuntu/Ubuntu-R.ttf';
                const boldFontUrl = 'https://pdf-lib.js.org/assets/ubuntu/Ubuntu-B.ttf';

                const [fontBytes, boldFontBytes] = await Promise.all([
                    fetch(fontUrl).then(res => res.arrayBuffer()),
                    fetch(boldFontUrl).then(res => res.arrayBuffer())
                ]);

                const pdfDoc = await PDFDocument.create();

                // Register fontkit with pdf-lib
                pdfDoc.registerFontkit(fontkit);

                // Embed the custom fonts
                const customFont = await pdfDoc.embedFont(fontBytes);
                const customBoldFont = await pdfDoc.embedFont(boldFontBytes);

                const page = pdfDoc.addPage();

                const {
                    EventCode, Name, Sport, Discipline, DateStart, DateEnd,
                    CITY, VENUE, LEVEL, POOL_SIZE, Organiser
                } = currentRecord;

                let y = 750;
                const x = 50;
                const lineHeight = 20;

                page.drawText('Event Report', { x, y, font: customBoldFont, size: 24, color: rgb(0.1, 0.1, 0.1) });
                y -= 40;

                const addDetail = (label, value) => {
                    if (y < 50) { // Add new page if content overflows
                        page = pdfDoc.addPage();
                        y = 780;
                    }
                    page.drawText(`${label}: `, { x, y, font: customBoldFont, size: 12 });
                    const labelWidth = customBoldFont.widthOfTextAtSize(`${label}: `, 12);
                    page.drawText(String(value || 'N/A'), { x: x + labelWidth + 2, y, font: customFont, size: 12 });
                    y -= lineHeight;
                };

                addDetail('Event Code', EventCode);
                addDetail('Name', Name);
                addDetail('Sport', Sport);
                addDetail('Discipline', Discipline);
                addDetail('Start Date', formatDate(DateStart));
                addDetail('End Date', formatDate(DateEnd));
                addDetail('City', CITY);
                addDetail('Venue', VENUE);
                addDetail('Level', LEVEL);
                addDetail('Pool Size', POOL_SIZE);
                addDetail('Organiser', Organiser);

                const pdfBytes = await pdfDoc.save();
                const filename = `Event_Report_${EventCode || 'Unknown'}.pdf`;
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);

                console.log(`[WIDGET] PDF downloaded: ${filename}`);

            } catch (error) {
                console.error("[WIDGET] Error generating PDF:", error);
                recordInfoElement.textContent = 'Error creating PDF. Check console.';
            } finally {
                downloadPdfButton.disabled = false;
                downloadPdfButton.textContent = 'Download PDF Report';
            }
        }

        // --- GRIST API INITIALIZATION ---

        // Check if the grist object exists.
        if (typeof grist === 'undefined') {
            document.getElementById('widget-container').innerHTML = '<div class="error-message">Error: Grist API not available.</div>';
            throw new Error("Grist API not found.");
        }

        // Signal to Grist that the widget is ready and requires full access.
        grist.ready({
            requiredAccess: 'full'
        });

        // Use grist.onRecord to listen for selections in the linked table.
        grist.onRecord(updateUI);

        // --- EVENT LISTENERS ---

        downloadPdfButton.addEventListener('click', generatePdfReport);

        // The debug button will manually fetch the currently selected record.
        debugButton.addEventListener('click', async () => {
            console.log("[WIDGET] Debug: Attempting to fetch selected record manually.");
            try {
                // Use the modern grist.fetchSelectedRecord() function
                const record = await grist.fetchSelectedRecord();
                if (record) {
                     console.log("[WIDGET] Debug: Fetched record successfully:", record);
                     recordInfoElement.textContent = `Debug Fetch OK: ${record.Name}`;
                     updateUI(record); // Update the whole UI with the fetched record
                } else {
                     console.log("[WIDGET] Debug: No record is currently selected.");
                     recordInfoElement.textContent = 'Debug: No record selected.';
                }
            } catch (error) {
                console.error("[WIDGET] Debug: Error fetching record:", error);
                recordInfoElement.textContent = 'Debug: Error fetching record.';
            }
        });
        
        // Enable the debug button now that listeners are attached.
        debugButton.disabled = false;

    </script>
</body>
</html>
