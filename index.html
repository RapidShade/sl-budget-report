<!DOCTYPE html>
<html>
<head>
    <title>Event PDF Budget & Revenue Report Widget</title>
    <meta charset="utf-8">
    <style>
        /* ================== EXISTING CSS (UNCHANGED) ================== */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu,
                         Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            color: #333;
            margin: 0;
            padding: 20px;
            background-color: #f8f8f8;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            box-sizing: border-box;
            text-align: center;
        }
        .container {
            text-align: left;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
        }
        h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }
        p {
            font-size: 1em;
            color: #666;
            margin-bottom: 25px;
            text-align: center;
        }
        .button-container {
            text-align: center;
            width: 100%;
        }
        button {
            background-color: #4CAF50; /* Grist-like green */
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        input[type="radio"] {
            margin-right: 5px;
        }
        label {
            margin-right: 15px;
            font-size: 0.95em;
            color: #555;
        }
        #record-info {
            margin-top: 15px;
            font-size: 0.9em;
            color: #555;
            min-height: 20px; /* To prevent layout shift */
            text-align: center;
        }
        .error-message {
            color: red;
            background-color: #ffe0e0;
            border: 1px solid red;
            padding: 10px;
            margin-top: 20px;
            border-radius: 5px;
        }
        #report-container {
            margin-top: 30px;
            text-align: left;
        }
        .event-details {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        .event-details h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        .event-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }
        .detail-item {
            font-size: 0.95em;
        }
        .detail-item strong {
            color: #495057;
        }
        .expense-group, .revenue-group {
            margin-bottom: 20px;
        }
        .expense-group h3, .revenue-group h3 {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            color: #495057;
            margin: 0 0 10px 0;
        }
        .expense-item, .revenue-item, .group-summary {
            display: flex;
            justify-content: space-between;
            padding: 8px 10px;
            border-bottom: 1px solid #dee2e6;
        }
        .group-summary {
            font-weight: bold;
            background-color: #f8f9fa;
            border-top: 2px solid #dee2e6;
            margin-top: 5px;
        }
        .grand-total {
            display: flex;
            justify-content: space-between;
            padding: 12px 10px;
            margin-top: 20px;
            background-color: #2c3e50;
            color: white;
            font-weight: bold;
            font-size: 1.2em;
            border-radius: 4px;
        }
        .expense-item:last-child, .revenue-item:last-child {
            border-bottom: none;
        }
    </style>

    <!-- pdf-lib and fontkit libraries for PDF generation -->
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit/dist/fontkit.umd.min.js"></script>
    <!-- Grist Plugin API -->
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
</head>

<body>
  <div class="container" id="widget-container">
    <h2>Event PDF Report</h2>
    <p id="message">Connecting to Grist... Please select an event record.</p>
    <div class="button-container">
      <!-- REPORT TYPE SELECTOR -->
      <label><input type="radio" name="reportType" value="expenses" checked>Expenses</label>
      <label><input type="radio" name="reportType" value="revenues">Revenues</label>
      <label><input type="radio" name="reportType" value="combined">Combined</label>
      <button id="downloadPdfButton" style="margin-left:20px;" disabled>Download PDF Report</button>
    </div>
    <div id="record-info"></div>
    <div id="report-container"></div>
  </div>

<script>
  console.log("RapidShade: [WIDGET] v7.12 Fixing grouping & combined logic");

  if (typeof PDFLib === 'undefined' || typeof fontkit === 'undefined') {
    document.getElementById('widget-container').innerHTML =
      '<div class="error-message">Error: PDF libraries not loaded.</div>';
    throw new Error("PDF-lib or fontkit not found.");
  }

  const { PDFDocument } = PDFLib;
  const messageElement    = document.getElementById('message');
  const downloadPdfButton = document.getElementById('downloadPdfButton');
  const recordInfoElement = document.getElementById('record-info');
  const reportContainer   = document.getElementById('report-container');

  let currentRecord = null;
  let allExpenseDetails = [];
  let allExpenseCategories = [];
  let allRevenueDetails = [];
  let allRevenueCategories = [];

  // —————————————————————————————————————————————
  // Helpers
  // —————————————————————————————————————————————
  const formatCurrency = (amt) =>
    (amt || 0).toLocaleString('el-GR', { style: 'currency', currency: 'EUR' });

  function formatDate(secOrDate) {
    if (!secOrDate) return 'N/A';
    let d = secOrDate instanceof Date ? secOrDate : new Date(secOrDate * 1000);
    return isNaN(d) ? 'Invalid Date' : d.toLocaleDateString('el-GR');
  }

  function tableToRecords(data) {
    if (!data || typeof data !== 'object' || Array.isArray(data)) {
      return Array.isArray(data) ? data : [];
    }
    const cols = Object.keys(data);
    if (!cols.length || !Array.isArray(data[cols[0]])) {
      return [];
    }
    const n = data[cols[0]].length;
    const recs = [];
    for (let i = 0; i < n; i++) {
      const rec = {};
      for (let c of cols) { rec[c] = data[c][i]; }
      recs.push(rec);
    }
    return recs;
  }

  // —————————————————————————————————————————————
  // Fetch Expenses + Revenues
  // —————————————————————————————————————————————
  async function fetchData() {
    try {
      const [ed, ec, rd, rc] = await Promise.all([
        grist.docApi.fetchTable('ExpenseDetails'),
        grist.docApi.fetchTable('ExpenseCategories'),
        grist.docApi.fetchTable('RevenueDetails'),
        grist.docApi.fetchTable('RevenueCategories'),
      ]);
      allExpenseDetails    = tableToRecords(ed);
      allExpenseCategories = tableToRecords(ec);
      allRevenueDetails    = tableToRecords(rd);
      allRevenueCategories = tableToRecords(rc);
      console.log(
        `Fetched ${allExpenseDetails.length} expense details, ` +
        `${allRevenueDetails.length} revenue details`
      );
    } catch (e) {
      console.error("Error fetching data:", e);
      reportContainer.innerHTML =
        `<div class="error-message">
           Error fetching data. Verify tables: ExpenseDetails, ExpenseCategories,
           RevenueDetails, RevenueCategories.
         </div>`;
    }
  }

  // —————————————————————————————————————————————
  // On record select
  // —————————————————————————————————————————————
  function onRecordUpdate(record) {
    currentRecord = record;
    if (record && Object.keys(record).length) {
      messageElement.style.display = 'none';
      downloadPdfButton.disabled = false;
      downloadPdfButton.style.display = 'inline-block';
      recordInfoElement.textContent = `Selected: ${record.Name || 'Unnamed Event'}`;
      renderHtmlReport();
    } else {
      messageElement.style.display = 'block';
      messageElement.textContent = "Please select an event record.";
      downloadPdfButton.style.display = 'none';
      downloadPdfButton.disabled = true;
      recordInfoElement.textContent = '';
      reportContainer.innerHTML = '';
    }
  }

  // —————————————————————————————————————————————
  // Render HTML preview (Expenses only)
  // —————————————————————————————————————————————
  function renderHtmlReport() {
    reportContainer.innerHTML = '';
    if (!currentRecord || !allExpenseDetails.length) { return; }

    // Event Details (HTML)
    const eventDiv = document.createElement('div');
    eventDiv.className = 'event-details';
    eventDiv.innerHTML = `
      <h3>Event Details</h3>
      <div class="event-details-grid">
        <div class="detail-item"><strong>Event Code:</strong> ${currentRecord.EventCode || 'N/A'}</div>
        <div class="detail-item"><strong>Name:</strong> ${currentRecord.Name || 'N/A'}</div>
        <div class="detail-item"><strong>Sport:</strong> ${currentRecord.Sport || 'N/A'}</div>
        <div class="detail-item"><strong>Discipline:</strong> ${currentRecord.Discipline || 'N/A'}</div>
        <div class="detail-item"><strong>Dates:</strong> ${formatDate(currentRecord.DateStart)} – ${formatDate(currentRecord.DateEnd)}</div>
        <div class="detail-item"><strong>City:</strong> ${currentRecord.CITY || 'N/A'}</div>
        <div class="detail-item"><strong>Venue:</strong> ${currentRecord.VENUE || 'N/A'}</div>
        <div class="detail-item"><strong>Level:</strong> ${currentRecord.LEVEL || 'N/A'}</div>
      </div>`;
    reportContainer.appendChild(eventDiv);

    // Expense grouping (same logic as PDF)
    const details = allExpenseDetails.filter(d => {
      const ref = d.Event;
      return Array.isArray(ref) ? ref[1] === currentRecord.id : ref === currentRecord.id;
    });
    // Categories used or all if none
    const usedIds = new Set(details.map(d =>
      Array.isArray(d.ExpenseCategory) ? d.ExpenseCategory[1] : d.ExpenseCategory
    ));
    const toShow = usedIds.size
      ? allExpenseCategories.filter(c => usedIds.has(c.id))
      : allExpenseCategories;
    toShow.sort((a,b) => (a.ExpCatCode||999) - (b.ExpCatCode||999))
      .forEach(cat => {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'expense-group';
        groupDiv.innerHTML = `<h3>${cat.Name}</h3>`;
        const groupItems = details.filter(d =>
          (Array.isArray(d.ExpenseCategory)?d.ExpenseCategory[1]:d.ExpenseCategory) === cat.id
        );
        let grpTotal = 0;
        if (groupItems.length) {
          groupItems.forEach(it => {
            const line = document.createElement('div');
            line.className = 'expense-item';
            line.innerHTML = `<span>${it.Description}</span><span>${formatCurrency(it.Budget)}</span>`;
            groupDiv.appendChild(line);
            grpTotal += it.Budget||0;
          });
        }
        // Even if no items, still show empty group
        const sumDiv = document.createElement('div');
        sumDiv.className = 'group-summary';
        sumDiv.innerHTML = `<span>Group Total</span><span>${formatCurrency(grpTotal)}</span>`;
        groupDiv.appendChild(sumDiv);
        reportContainer.appendChild(groupDiv);
      });

    // Grand total
    const grand = details.reduce((s,d)=>s + (d.Budget||0), 0);
    const gt = document.createElement('div');
    gt.className = 'grand-total';
    gt.innerHTML = `<span>GRAND TOTAL</span><span>${formatCurrency(grand)}</span>`;
    reportContainer.appendChild(gt);
  }

  // —————————————————————————————————————————————
  // Dispatch download
  // —————————————————————————————————————————————
  async function onDownloadClick() {
    const rpt = document.querySelector('input[name=reportType]:checked').value;
    if (rpt === 'expenses') {
      await generateExpenseReport();
    } else if (rpt === 'revenues') {
      await generateRevenueReport();
    } else {
      await generateCombinedReport();
    }
  }

  // —————————————————————————————————————————————
  // Generate Expenses PDF
  // —————————————————————————————————————————————
  async function generateExpenseReport() {
    console.log("Generating Expenses PDF…");
    const pdfDoc = await PDFDocument.create();
    await buildSection(pdfDoc, allExpenseDetails, allExpenseCategories, 'Expenses', false);
    await finalizeAndDownload(pdfDoc, 'Expenses');
  }

  // —————————————————————————————————————————————
  // Generate Revenues PDF
  // —————————————————————————————————————————————
  async function generateRevenueReport() {
    console.log("Generating Revenues PDF…");
    const pdfDoc = await PDFDocument.create();
    await buildSection(pdfDoc, allRevenueDetails, allRevenueCategories, 'Revenues', true);
    await finalizeAndDownload(pdfDoc, 'Revenues');
  }

  // —————————————————————————————————————————————
  // Generate Combined PDF
  // —————————————————————————————————————————————
  async function generateCombinedReport() {
    console.log("Generating Combined PDF…");
    const pdfDoc = await PDFDocument.create();
    // Section 1: Expenses
    await buildSection(pdfDoc, allExpenseDetails, allExpenseCategories, 'Expenses', false);
    // Section 2: Revenues
    await buildSection(pdfDoc, allRevenueDetails, allRevenueCategories, 'Revenues', true);
    await finalizeAndDownload(pdfDoc, 'Combined');
  }

  // —————————————————————————————————————————————
  // Build one section (header, event, grouping)
  // —————————————————————————————————————————————
  async function buildSection(pdfDoc, details, categories, sectionTitle, isRevenue) {
    // Register fonts once
    pdfDoc.registerFontkit(fontkit);
    if (!pdfDoc._fontsLoaded) {
      // Load Ubuntu fonts
      const rUrl = 'https://pdf-lib.js.org/assets/ubuntu/Ubuntu-R.ttf';
      const bUrl = 'https://pdf-lib.js.org/assets/ubuntu/Ubuntu-B.ttf';
      const [rBytes, bBytes] = await Promise.all([
        fetch(rUrl).then(r=>r.arrayBuffer()),
        fetch(bUrl).then(r=>r.arrayBuffer())
      ]);
      pdfDoc._uf = await pdfDoc.embedFont(rBytes);
      pdfDoc._ub = await pdfDoc.embedFont(bBytes);
      pdfDoc._fontsLoaded = true;
    }
    const uf = pdfDoc._uf, ub = pdfDoc._ub;

    // Add new page
    const page = pdfDoc.addPage();
    const { width, height } = page.getSize();
    const left  = 50;
    const right = width - 50;
    let y = height - 60;

    // HEADER
    page.drawText(`Event ${sectionTitle} Report`, {
      x: left, y: height - 30, font: ub, size: 18
    });

    // EVENT DETAILS (same for all)
    const eventFields = [
      `Event Code: ${currentRecord.EventCode || 'N/A'}`,
      `Name      : ${currentRecord.Name      || 'N/A'}`,
      `Sport     : ${currentRecord.Sport     || 'N/A'}`,
      `Discipline: ${currentRecord.Discipline|| 'N/A'}`,
      `Dates     : ${formatDate(currentRecord.DateStart)} – ${formatDate(currentRecord.DateEnd)}`,
      `Region    : ${currentRecord.PERIF_CITY|| 'N/A'}`,
      `City      : ${currentRecord.CITY       || 'N/A'}`,
      `Venue     : ${currentRecord.VENUE      || 'N/A'}`,
      `Level     : ${currentRecord.LEVEL      || 'N/A'}`,
      `Pool Size : ${currentRecord.POOL_SIZE  || 'N/A'}`,
      `Organiser : ${currentRecord.Organiser  || 'N/A'}`
    ];
    y -= 30;
    eventFields.forEach(line => {
      page.drawText(line, { x: left, y, font: uf, size: 12 });
      y -= 16;
    });
    y -= 10;

    // GROUPING logic: only categories used in details, else all categories
    const detailIds = new Set(details.map(d => {
      const ref = isRevenue ? d.RevenueCategory : d.ExpenseCategory;
      return Array.isArray(ref) ? ref[1] : ref;
    }));
    const showCats = detailIds.size
      ? categories.filter(c => detailIds.has(c.id))
      : categories;
    showCats.sort((a,b) => (a.ExpCatCode||999) - (b.ExpCatCode||999));

    // Draw each group
    let sectionTotal = 0;
    for (let cat of showCats) {
      if (y < 100) {
        pdfDoc.addPage();
        y = height - 60;
      }
      page.drawText(cat.Name, { x: left, y, font: ub, size: 14 });
      y -= 20;

      const items = details.filter(d => {
        const ref = isRevenue ? d.RevenueCategory : d.ExpenseCategory;
        const cid = Array.isArray(ref) ? ref[1] : ref;
        return cid === cat.id;
      });
      let grpTotal = 0;

      // Draw items (if any)
      if (items.length) {
        for (let it of items) {
          page.drawText(it.Description || it.LineDescription || '', {
            x: left + 20, y, font: uf, size: 11
          });
          const val = isRevenue ? it.Amount : it.Budget;
          const amt = formatCurrency(val);
          page.drawText(amt, {
            x: right - uf.widthOfTextAtSize(amt,11),
            y, font: uf, size: 11
          });
          y -= 16;
          grpTotal += val || 0;
        }
      }
      // Even if no items, grpTotal stays 0
      const grpStr = formatCurrency(grpTotal);
      page.drawText('Group Total:', {
        x: right - 80 - ub.widthOfTextAtSize(grpStr,12),
        y, font: ub, size: 12
      });
      page.drawText(grpStr, {
        x: right - ub.widthOfTextAtSize(grpStr,12),
        y, font: ub, size: 12
      });
      y -= 24;
      sectionTotal += grpTotal;
    }

    // SECTION TOTAL
    if (y < 80) {
      pdfDoc.addPage();
      y = height - 60;
    }
    const secStr = `TOTAL ${sectionTitle.toUpperCase()}: ${formatCurrency(sectionTotal)}`;
    page.drawText(secStr, {
      x: right - ub.widthOfTextAtSize(secStr,14),
      y, font: ub, size: 14
    });
    y -= 30;
  }

  // —————————————————————————————————————————————
  // Footer, save, and download
  // —————————————————————————————————————————————
  async function finalizeAndDownload(pdfDoc, suffix) {
    // FOOTER (timestamp, text, page numbers)
    const pages = pdfDoc.getPages();
    const timestamp = new Date().toLocaleString('el-GR');
    const footerText = 'Generated by RapidShade Widget';
    const uf = pdfDoc._uf;
    pages.forEach((pg, idx) => {
      pg.drawText(`Date: ${timestamp}`, { x: 50, y: 20, font: uf, size: 8 });
      pg.drawText(footerText, { x: 170, y: 20, font: uf, size: 8 });
      const num = `Page ${idx+1} of ${pages.length}`;
      const { width } = pg.getSize();
      pg.drawText(num, {
        x: width - 50 - uf.widthOfTextAtSize(num,8),
        y: 20,
        font: uf,
        size: 8
      });
    });

    // SAVE & DOWNLOAD
    const pdfBytes = await pdfDoc.save();
    const blob = new Blob([pdfBytes], { type:'application/pdf' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href     = url;
    a.download = `${currentRecord.Name || 'report'}_${suffix}.pdf`;
    a.click();
    URL.revokeObjectURL(url);

    downloadPdfButton.disabled = false;
    downloadPdfButton.textContent = 'Download PDF Report';
  }

  // —————————————————————————————————————————————
  // Initialization
  // —————————————————————————————————————————————
  grist.ready({
    requiredAccess: 'full',
    columns: [
      'EventCode','Name','Sport','Discipline','DateStart','DateEnd',
      'PERIF_CITY','CITY','VENUE','LEVEL','POOL_SIZE','Organiser'
    ]
  });
  fetchData();
  grist.onRecord(onRecordUpdate);
  downloadPdfButton.addEventListener('click', onDownloadClick);

</script>
</body>
</html>
