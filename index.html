<!DOCTYPE html>
<html>
<head>
    <title>Event PDF Budget Report Widget</title>
    <meta charset="utf-8">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            color: #333;
            margin: 0;
            padding: 20px;
            background-color: #f8f8f8;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            box-sizing: border-box;
            text-align: center;
        }
        .container {
            text-align: left;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
        }
        h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }
        p {
            font-size: 1em;
            color: #666;
            margin-bottom: 25px;
            text-align: center;
        }
        .button-container {
            text-align: center;
            width: 100%;
        }
        button {
            background-color: #4CAF50; /* Grist-like green */
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        #record-info {
            margin-top: 15px;
            font-size: 0.9em;
            color: #555;
            min-height: 20px; /* To prevent layout shift */
            text-align: center;
        }
        .error-message {
            color: red;
            background-color: #ffe0e0;
            border: 1px solid red;
            padding: 10px;
            margin-top: 20px;
            border-radius: 5px;
        }
        #report-container {
            margin-top: 30px;
            text-align: left;
        }
        .event-details {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        .event-details h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        .event-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }
        .detail-item {
            font-size: 0.95em;
        }
        .detail-item strong {
            color: #495057;
        }
        .expense-group {
            margin-bottom: 20px;
        }
        .expense-group h3 {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            color: #495057;
            margin: 0 0 10px 0;
        }
        .expense-item, .group-summary {
            display: flex;
            justify-content: space-between;
            padding: 8px 10px;
            border-bottom: 1px solid #dee2e6;
        }
        .group-summary {
            font-weight: bold;
            background-color: #f8f9fa;
            border-top: 2px solid #dee2e6;
            margin-top: 5px;
        }
        .grand-total {
            display: flex;
            justify-content: space-between;
            padding: 12px 10px;
            margin-top: 20px;
            background-color: #2c3e50;
            color: white;
            font-weight: bold;
            font-size: 1.2em;
            border-radius: 4px;
        }
        .expense-item:last-child {
            border-bottom: none;
        }
    </style>
    <!-- pdf-lib and fontkit libraries for PDF generation -->
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit/dist/fontkit.umd.min.js"></script>
    <!-- Grist Plugin API -->
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
</head>
<body>
    <div class="container" id="widget-container">
        <h2>Event PDF Budget Report</h2>
        <p id="message">Connecting to Grist... Please select an event record.</p>
        <div class="button-container">
            <button id="downloadPdfButton" style="display: none;" disabled>Download PDF Report</button>
        </div>
        <div id="record-info"></div>
        <div id="report-container"></div>
    </div>

<script>
  console.log("RapidShade: [WIDGET] v7.10 Starting");

  // Ensure PDF-lib and fontkit are loaded
  if (typeof PDFLib === 'undefined' || typeof fontkit === 'undefined') {
    document.getElementById('widget-container').innerHTML =
      '<div class="error-message">Error: PDF libraries not loaded.</div>';
    throw new Error("PDF-lib or fontkit not found.");
  }

  const { PDFDocument } = PDFLib;
  const messageElement    = document.getElementById('message');
  const downloadPdfButton = document.getElementById('downloadPdfButton');
  const recordInfoElement = document.getElementById('record-info');
  const reportContainer   = document.getElementById('report-container');

  let currentRecord = null;
  let allExpenseDetails = [];
  let allExpenseCategories = [];

  // Helper to format currency
  const formatCurrency = (amount) =>
    (amount || 0).toLocaleString('el-GR', { style: 'currency', currency: 'EUR' });

  // Convert Grist table payload to array of records
  function tableToRecords(data) {
    if (!data || typeof data !== 'object' || Array.isArray(data)) {
      return Array.isArray(data) ? data : [];
    }
    const columns = Object.keys(data);
    if (columns.length === 0 || !Array.isArray(data[columns[0]])) {
      return [];
    }
    const numRows = data[columns[0]].length;
    const records = [];
    for (let i = 0; i < numRows; i++) {
      const rec = {};
      for (const col of columns) {
        rec[col] = data[col][i];
      }
      records.push(rec);
    }
    return records;
  }

  // Fetch ExpenseDetails + ExpenseCategories
  async function fetchData() {
    try {
      const rawDetails    = await grist.docApi.fetchTable('ExpenseDetails');
      const rawCategories = await grist.docApi.fetchTable('ExpenseCategories');

      allExpenseDetails    = tableToRecords(rawDetails);
      allExpenseCategories = tableToRecords(rawCategories);

      console.log("RapidShade: Fetched ExpenseDetails:", allExpenseDetails.length);
      console.log("RapidShade: Fetched ExpenseCategories:", allExpenseCategories.length);
    } catch (error) {
      console.error("Error fetching data:", error);
      reportContainer.innerHTML =
        `<div class="error-message">
           Error fetching data. Check table names ('ExpenseDetails', 'ExpenseCategories')
           and ensure the widget has 'full' access.
         </div>`;
    }
  }

  // Render on-screen HTML preview
  function renderHtmlReport() {
    reportContainer.innerHTML = '';
    if (!currentRecord || !allExpenseDetails.length) { return; }

    // --- Event Details ---
    const eventDiv = document.createElement('div');
    eventDiv.className = 'event-details';
    eventDiv.innerHTML = `
      <h3>Event Details</h3>
      <div class="event-details-grid">
        <div class="detail-item"><strong>Event:</strong> ${currentRecord.Name || 'N/A'}</div>
        <div class="detail-item"><strong>Sport:</strong> ${currentRecord.Sport || 'N/A'}</div>
        <div class="detail-item"><strong>Dates:</strong> ${formatDate(currentRecord.DateStart)} to ${formatDate(currentRecord.DateEnd)}</div>
        <div class="detail-item"><strong>Location:</strong> ${currentRecord.CITY || 'N/A'}, ${currentRecord.VENUE || 'N/A'}</div>
        <div class="detail-item"><strong>Level:</strong> ${currentRecord.LEVEL || 'N/A'}</div>
      </div>
    `;
    reportContainer.appendChild(eventDiv);

    // --- Filter details for this event ---
    const details = allExpenseDetails.filter(d => {
      const ref = d.Event;
      return Array.isArray(ref) ? ref[1] === currentRecord.id : ref === currentRecord.id;
    });
    console.log(`RapidShade: Found ${details.length} lines for event ID ${currentRecord.id}`);

    // --- Grouping by category ---
    const categoryMap = new Map(allExpenseCategories.map(c => [c.id, c]));
    let grandTotal = 0;
    const grouped = details.reduce((acc, d) => {
      const cid = Array.isArray(d.ExpenseCategory) ? d.ExpenseCategory[1] : d.ExpenseCategory;
      const cat = categoryMap.get(cid);
      if (!cat) { return acc; }
      const groupName   = cat.Name || 'Uncategorized';
      const displayOrder = cat.ExpCatCode || 999;
      if (!acc[groupName]) {
        acc[groupName] = { items: [], total: 0, displayOrder };
      }
      acc[groupName].items.push({
        description: d.Description || '',
        amount:      d.Budget      || 0,
      });
      acc[groupName].total += d.Budget || 0;
      return acc;
    }, {});

    // Sort and render each group
    Object.entries(grouped)
      .sort(([,a],[,b]) => a.displayOrder - b.displayOrder)
      .forEach(([grp, data]) => {
        const gdiv = document.createElement('div');
        gdiv.className = 'expense-group';
        gdiv.innerHTML = `<h3>${grp}</h3>`;
        data.items.forEach(item => {
          const iv = document.createElement('div');
          iv.className = 'expense-item';
          iv.innerHTML = `<span>${item.description}</span><span>${formatCurrency(item.amount)}</span>`;
          gdiv.appendChild(iv);
        });
        const sum = document.createElement('div');
        sum.className = 'group-summary';
        sum.innerHTML = `<span>Group Total</span><span>${formatCurrency(data.total)}</span>`;
        gdiv.appendChild(sum);
        reportContainer.appendChild(gdiv);
        grandTotal += data.total;
      });

    // Grand Total
    const gtot = document.createElement('div');
    gtot.className = 'grand-total';
    gtot.innerHTML = `<span>GRAND TOTAL</span><span>${formatCurrency(grandTotal)}</span>`;
    reportContainer.appendChild(gtot);
  }

  // PDF generator – fetch Ubuntu fonts from pdf-lib.js.org
async function generatePdfReport() {
  console.log("RapidShade: [WIDGET] v7.11 PDF generator with event data");
  if (!currentRecord) {
    alert("Please select an event first.");
    return;
  }
  downloadPdfButton.disabled = true;
  downloadPdfButton.textContent = 'Generating...';

  try {
    const pdfDoc = await PDFDocument.create();
    pdfDoc.registerFontkit(fontkit);

    // Fetch Ubuntu fonts
    const fontUrl     = 'https://pdf-lib.js.org/assets/ubuntu/Ubuntu-R.ttf';
    const boldFontUrl = 'https://pdf-lib.js.org/assets/ubuntu/Ubuntu-B.ttf';
    const [rb, bb]    = await Promise.all([
      fetch(fontUrl).then(r=>r.arrayBuffer()),
      fetch(boldFontUrl).then(r=>r.arrayBuffer()),
    ]);
    const ubuntuFont     = await pdfDoc.embedFont(rb);
    const ubuntuBoldFont = await pdfDoc.embedFont(bb);

    let page = pdfDoc.addPage();
    const { width, height } = page.getSize();
    const leftMargin  = 50;
    const rightMargin = width - leftMargin;
    let y = height - 50;

    // ——— Event header & details ———
    page.drawText(currentRecord.Name || 'Event', {
      x: leftMargin, y, font: ubuntuBoldFont, size: 16
    });
    y -= 25;

    const eventLines = [
      `Sport: ${currentRecord.Sport  || 'N/A'}`,
      `Discipline: ${currentRecord.Discipline || 'N/A'}`,
      `Dates: ${formatDate(currentRecord.DateStart)} – ${formatDate(currentRecord.DateEnd)}`,
      `Location: ${currentRecord.CITY || 'N/A'}, ${currentRecord.VENUE || 'N/A'}`,
      `Level: ${currentRecord.LEVEL || 'N/A'}`
    ];
    eventLines.forEach(line => {
      page.drawText(line, {
        x: leftMargin, y, font: ubuntuFont, size: 12
      });
      y -= 18;
    });

    y -= 10;  // a bit of spacing before the budget groups

    // ——— Filter & group budget details ———
    const details = allExpenseDetails.filter(d => {
      const ref = d.Event;
      return Array.isArray(ref) ? ref[1] === currentRecord.id : ref === currentRecord.id;
    });
    const categoryMap = new Map(allExpenseCategories.map(c=>[c.id,c]));
    let grandTotal = 0;

    const grouped = details.reduce((acc, d) => {
      const cid = Array.isArray(d.ExpenseCategory) ? d.ExpenseCategory[1] : d.ExpenseCategory;
      const cat = categoryMap.get(cid);
      if (!cat) { return acc; }
      const name  = cat.Name      || 'Uncategorized';
      const order = cat.ExpCatCode|| 999;
      if (!acc[name]) {
        acc[name] = { items: [], total: 0, order };
      }
      acc[name].items.push({ desc: d.Description||'', amt: d.Budget||0 });
      acc[name].total += d.Budget||0;
      return acc;
    }, {});

    Object.entries(grouped)
      .sort(([,a],[,b]) => a.order - b.order)
      .forEach(([grp,data]) => {
        if (y < 120) { page = pdfDoc.addPage(); y = height - 50; }
        // Category header
        page.drawText(grp, { x: leftMargin, y, font: ubuntuBoldFont, size: 14 });
        y -= 22;
        data.items.forEach(item => {
          page.drawText(item.desc, {
            x: leftMargin+20, y, font: ubuntuFont, size: 11
          });
          const amt = formatCurrency(item.amt);
          page.drawText(amt, {
            x: rightMargin - ubuntuFont.widthOfTextAtSize(amt,11),
            y, font: ubuntuFont, size: 11
          });
          y -= 16;
        });
        // Subtotal
        const sub = formatCurrency(data.total);
        page.drawText('Group Total:', {
          x: rightMargin - ubuntuBoldFont.widthOfTextAtSize(sub, 12) - 80,
          y, font: ubuntuBoldFont, size: 12
        });
        page.drawText(sub, {
          x: rightMargin - ubuntuBoldFont.widthOfTextAtSize(sub, 12),
          y, font: ubuntuBoldFont, size: 12
        });
        y -= 24;
        grandTotal += data.total;
      });

    // ——— Grand total ———
    if (y < 80) { page = pdfDoc.addPage(); y = height - 50; }
    const grandStr = `GRAND TOTAL: ${formatCurrency(grandTotal)}`;
    page.drawText(grandStr, {
      x: rightMargin - ubuntuBoldFont.widthOfTextAtSize(grandStr, 14),
      y, font: ubuntuBoldFont, size: 14
    });

    // ——— Save & download ———
    const pdfBytes = await pdfDoc.save();
    const blob     = new Blob([pdfBytes], {type:'application/pdf'});
    const url      = URL.createObjectURL(blob);
    const a        = document.createElement('a');
    a.href         = url;
    a.download     = `${currentRecord.Name||'report'}.pdf`;
    a.click();
    URL.revokeObjectURL(url);

  } catch (e) {
    console.error("RapidShade: [WIDGET] Error generating PDF:", e);
    recordInfoElement.textContent = 'Error generating PDF — see console.';
  } finally {
    downloadPdfButton.disabled = false;
    downloadPdfButton.textContent = 'Download PDF Report';
  }
}

  console.log("RapidShade: [WIDGET] v7.10 PDF fix applied");

  // Grist init
  grist.ready({
    requiredAccess: 'full',
    columns: [
      'EventCode','Name','Sport','Discipline','DateStart','DateEnd',
      'PERIF_CITY','CITY','VENUE','LEVEL','POOL_SIZE','Organiser'
    ]
  });

  // Initial data fetch and event wiring
  fetchData();
  grist.onRecord(onRecordUpdate);
  downloadPdfButton.addEventListener('click', generatePdfReport);

  function onRecordUpdate(record) {
    currentRecord = record;
    if (record && Object.keys(record).length) {
      console.log("RapidShade: [WIDGET] Record selected:", record);
      messageElement.style.display = 'none';
      downloadPdfButton.style.display = 'inline-block';
      downloadPdfButton.disabled = false;
      recordInfoElement.textContent = `Selected: ${record.Name || 'Unnamed Event'}`;
      renderHtmlReport();
    } else {
      messageElement.style.display = 'block';
      messageElement.textContent = "Please select a record in the Events table.";
      downloadPdfButton.style.display = 'none';
      recordInfoElement.textContent = '';
      reportContainer.innerHTML = '';
    }
  }

  function formatDate(sec) {
    if (!sec) { return 'N/A'; }
    const d = new Date(sec * 1000);
    return isNaN(d) ? 'Invalid Date' : d.toLocaleDateString('el-GR');
  }
</script>

</body>
</html>
