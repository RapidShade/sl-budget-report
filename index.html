<!DOCTYPE html>
<html>
<head>
    <title>Event PDF Budget & Revenue Report Widget</title>
    <meta charset="utf-8">
    <style>
        /* ================== EXISTING CSS (UNCHANGED) ================== */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu,
                         Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            color: #333;
            margin: 0;
            padding: 20px;
            background-color: #f8f8f8;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            box-sizing: border-box;
            text-align: center;
        }
        .container {
            text-align: left;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
        }
        h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }
        p {
            font-size: 1em;
            color: #666;
            margin-bottom: 25px;
            text-align: center;
        }
        .button-container {
            text-align: center;
            width: 100%;
        }
        button {
            background-color: #4CAF50; /* Grist-like green */
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        input[type="radio"] {
            margin-right: 5px;
        }
        label {
            margin-right: 15px;
            font-size: 0.95em;
            color: #555;
        }
        #record-info {
            margin-top: 15px;
            font-size: 0.9em;
            color: #555;
            min-height: 20px; /* To prevent layout shift */
            text-align: center;
        }
        .error-message {
            color: red;
            background-color: #ffe0e0;
            border: 1px solid red;
            padding: 10px;
            margin-top: 20px;
            border-radius: 5px;
        }
        #report-container {
            margin-top: 30px;
            text-align: left;
        }
        .event-details {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        .event-details h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        .event-details-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 10px;
        }
        .detail-item {
            font-size: 0.95em;
        }
        .detail-item.full-width {
            grid-column: 1 / -1;
        }
        .detail-item strong {
            color: #495057;
        }
        .expense-group, .revenue-group {
            margin-bottom: 20px;
        }
        .expense-group h3, .revenue-group h3 {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            color: #495057;
            margin: 0 0 10px 0;
        }
        .expense-item, .revenue-item, .group-summary {
            display: flex;
            justify-content: space-between;
            padding: 8px 10px;
            border-bottom: 1px solid #dee2e6;
        }
        .group-summary {
            font-weight: bold;
            background-color: #f8f9fa;
            border-top: 2px solid #dee2e6;
            margin-top: 5px;
        }
        .grand-total {
            display: flex;
            justify-content: space-between;
            padding: 12px 10px;
            margin-top: 20px;
            background-color: #2c3e50;
            color: white;
            font-weight: bold;
            font-size: 1.2em;
            border-radius: 4px;
        }
        .expense-item:last-child, .revenue-item:last-child {
            border-bottom: none;
        }
    </style>

    <!-- pdf-lib and fontkit for PDF generation -->
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit/dist/fontkit.umd.min.js"></script>
    <!-- Grist Plugin API -->
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
</head>
<body>
  <div class="container" id="widget-container">
    <h2>Event PDF Report</h2>
    <p id="message">Connecting to Grist... Please select an event record.</p>
    <div class="button-container">
      <!-- REPORT TYPE SELECTOR -->
      <label><input type="radio" name="reportType" value="expenses" checked>Expenses</label>
      <label><input type="radio" name="reportType" value="revenues">Revenues</label>
      <label><input type="radio" name="reportType" value="combined">Combined</label>
      <button id="downloadPdfButton" style="margin-left:20px;" disabled>Download PDF Report</button>
    </div>
    <div id="record-info"></div>
    <div id="report-container"></div>
  </div>

<script>
  console.log("RapidShade: [WIDGET] v8.2 ▶️ Page breaks & detail lines option");

  if (typeof PDFLib === 'undefined' || typeof fontkit === 'undefined') {
    document.getElementById('widget-container').innerHTML =
      '<div class="error-message">Error: PDF libraries not loaded.</div>';
    throw new Error("PDF-lib or fontkit not found.");
  }

  const { PDFDocument, rgb } = PDFLib;  // import rgb for line color
  const messageElement    = document.getElementById('message');
  const downloadPdfButton = document.getElementById('downloadPdfButton');
  const recordInfoElement = document.getElementById('record-info');
  const reportContainer   = document.getElementById('report-container');

  let currentRecord     = null;
  let allExpenses       = [], allExpenseDetails = [], allExpenseCats = [];
  let allRevenues       = [], allRevenueDetails = [], allRevenueCats = [];

  // ————— CONFIG —————————————————————————————————————————————
  // Toggle thin lines under each PDF detail row
  const enablePdfDetailLines = true;    // set false to disable
  const pdfDetailLineWidth   = 0.5;     // thickness in points
  const pdfDetailLineColor   = rgb(0.75, 0.75, 0.75);  // light gray
  // —————————————————————————————————————————————————

  const formatCurrency = amt =>
    (amt || 0).toLocaleString('el-GR', { style: 'currency', currency: 'EUR' });
  function formatDate(secOrDate) {
    if (!secOrDate) return 'N/A';
    const d = secOrDate instanceof Date
      ? secOrDate
      : new Date(secOrDate * 1000);
    return isNaN(d) ? 'Invalid Date' : d.toLocaleDateString('el-GR');
  }
  function tableToRecords(data) {
    if (!data || typeof data!=='object' || Array.isArray(data)) {
      return Array.isArray(data)?data:[];
    }
    const cols = Object.keys(data);
    if (!cols.length || !Array.isArray(data[cols[0]])) return [];
    const n = data[cols[0]].length, recs = [];
    for (let i = 0; i < n; i++) {
      const rec = {};
      for (let c of cols) rec[c] = data[c][i];
      recs.push(rec);
    }
    return recs;
  }

  async function fetchData() {
    try {
      const [er, ed, ec, rr, rd, rc] = await Promise.all([
        grist.docApi.fetchTable('Expenses'),
        grist.docApi.fetchTable('ExpenseDetails'),
        grist.docApi.fetchTable('ExpenseCategories'),
        grist.docApi.fetchTable('Revenues'),
        grist.docApi.fetchTable('RevenueDetails'),
        grist.docApi.fetchTable('RevenueCategories'),
      ]);
      allExpenses       = tableToRecords(er);
      allExpenseDetails = tableToRecords(ed);
      allExpenseCats    = tableToRecords(ec);
      allRevenues       = tableToRecords(rr);
      allRevenueDetails = tableToRecords(rd);
      allRevenueCats    = tableToRecords(rc);
      console.log(`Loaded ${allExpenses.length} Expenses, ${allRevenues.length} Revenues`);
    } catch (e) {
      console.error("Error fetching data:", e);
      reportContainer.innerHTML = `
        <div class="error-message">
          Error fetching tables.
        </div>`;
    }
  }

  function onRecordUpdate(record) {
    currentRecord = record;
    if (record && Object.keys(record).length) {
      messageElement.style.display    = 'none';
      downloadPdfButton.disabled      = false;
      downloadPdfButton.style.display = 'inline-block';
      recordInfoElement.textContent   = `Selected: ${record.Name}`;
      renderHtmlReport();
    } else {
      messageElement.style.display    = 'block';
      messageElement.textContent      = "Please select an event record.";
      downloadPdfButton.style.display = 'none';
      downloadPdfButton.disabled      = true;
      recordInfoElement.textContent   = '';
      reportContainer.innerHTML       = '';
    }
  }

  function renderHtmlReport() {
    reportContainer.innerHTML = '';
    if (!currentRecord) { return; }

    // REPORT HEADING
    const rpt = document.querySelector('input[name=reportType]:checked').value;
    const headingText = rpt==='expenses'? 'Expenses Report'
                        : rpt==='revenues'? 'Revenues Report'
                                          : 'Combined Report';
    const heading = document.createElement('h3');
    heading.textContent = headingText;
    reportContainer.appendChild(heading);

    // EVENT DETAILS (full-width Name + 3-column grid)
    const ev = document.createElement('div');
    ev.className = 'event-details';
    ev.innerHTML = `
      <h3>Event Details</h3>
      <div class="event-details-grid">
        <div class="detail-item full-width"><strong>Name:</strong> ${currentRecord.Name||'N/A'}</div>
        <div class="detail-item"><strong>Code:</strong> ${currentRecord.EventCode||'N/A'}</div>
        <div class="detail-item"><strong>Sport:</strong> ${currentRecord.Sport||'N/A'}</div>
        <div class="detail-item"><strong>Discipline:</strong> ${currentRecord.Discipline||'N/A'}</div>
        <div class="detail-item"><strong>Dates:</strong> ${formatDate(currentRecord.DateStart)} – ${formatDate(currentRecord.DateEnd)}</div>
        <div class="detail-item"><strong>City:</strong> ${currentRecord.CITY||'N/A'}</div>
        <div class="detail-item"><strong>Venue:</strong> ${currentRecord.VENUE||'N/A'}</div>
        <div class="detail-item"><strong>Level:</strong> ${currentRecord.LEVEL||'N/A'}</div>
        <!-- Uncomment additional fields as needed:
        <div class="detail-item"><strong>PERIF_CITY:</strong> ${currentRecord.PERIF_CITY||'N/A'}</div>
        <div class="detail-item"><strong>POOL_SIZE:</strong> ${currentRecord.POOL_SIZE||'N/A'}</div>
        <div class="detail-item"><strong>Organiser:</strong> ${currentRecord.Organiser||'N/A'}</div>
        -->
      </div>`;
    reportContainer.appendChild(ev);

    // SECTIONS
    if ((rpt==='expenses'||rpt==='combined') && allExpenses.length) {
      renderGroups('Expenses', allExpenses, allExpenseDetails, allExpenseCats, 'Expense', 'expense-group','expense-item');
    }
    if ((rpt==='revenues'||rpt==='combined') && allRevenues.length) {
      renderGroups('Revenues', allRevenues, allRevenueDetails, allRevenueCats, 'Revenue','revenue-group','revenue-item');
    }

    // NO RECORDS
    if ((rpt==='expenses'&&!allExpenses.length)
     ||(rpt==='revenues'&&!allRevenues.length)
     ||(rpt==='combined'&&!allExpenses.length&&!allRevenues.length)) {
      const p = document.createElement('p');
      p.textContent = 'No records to display.';
      reportContainer.appendChild(p);
    }
  }

  function renderGroups(title, headers, details, cats, detailRef, gClass, iClass) {
    let grand = 0;
    reportContainer.appendChild(Object.assign(document.createElement('h3'),{textContent:title}));

    const hdrs = headers.filter(h=>{
      const r=h.Event; return Array.isArray(r)?r[1]===currentRecord.id:r===currentRecord.id;
    });
    hdrs.forEach(h=>{
      const catObj = cats.find(c=>c.id===h.Category);
      const catName=catObj?catObj.Name:'No Category';
      const desc   = h.Description?` > ${h.Description}`:'';
      const titleLine = catName+desc;
      const gDiv = document.createElement('div');
      gDiv.className = gClass;
      gDiv.innerHTML = `<h3>${titleLine}</h3>`;
      let sum=0;
      details.filter(d=>{
        const r=d[detailRef]; const id=Array.isArray(r)?r[1]:r;
        return id===h.id;
      }).forEach(d=>{
        const val=d.Budget||d.Amount||0;
        sum+=val;
        const li=document.createElement('div'), txt=d.Description||'';
        li.className=iClass;
        li.innerHTML=`<span>${txt}</span><span>${formatCurrency(val)}</span>`;
        gDiv.appendChild(li);
      });
      const sumDiv=document.createElement('div');
      sumDiv.className='group-summary';
      sumDiv.innerHTML=`<span>Group Total</span><span>${formatCurrency(sum)}</span>`;
      gDiv.appendChild(sumDiv);
      reportContainer.appendChild(gDiv);
      grand+=sum;
    });

    const gt=document.createElement('div');
    gt.className='grand-total';
    gt.innerHTML=`<span>GRAND TOTAL ${title.toUpperCase()}</span><span>${formatCurrency(grand)}</span>`;
    reportContainer.appendChild(gt);
  }

  document.querySelectorAll('input[name=reportType]')
    .forEach(r=>r.addEventListener('change', renderHtmlReport));
  downloadPdfButton.addEventListener('click', onDownloadClick);

  async function onDownloadClick() {
    const rpt = document.querySelector('input[name=reportType]:checked').value;
    if (rpt==='expenses')      await pdfReport(false,false);
    else if (rpt==='revenues') await pdfReport(true ,false);
    else                       await pdfReport(false,true );
  }

  async function pdfReport(isRev,isComb) {
    downloadPdfButton.disabled   = true;
    downloadPdfButton.textContent = 'Generating...';
    try {
      const pdfDoc = await PDFDocument.create();
      pdfDoc.registerFontkit(fontkit);
      const [rBytes,bBytes]=await Promise.all([
        fetch('https://pdf-lib.js.org/assets/ubuntu/Ubuntu-R.ttf').then(r=>r.arrayBuffer()),
        fetch('https://pdf-lib.js.org/assets/ubuntu/Ubuntu-B.ttf').then(r=>r.arrayBuffer())
      ]);
      const uf=await pdfDoc.embedFont(rBytes), ub=await pdfDoc.embedFont(bBytes);

      // first page header
      let page = pdfDoc.addPage();
      const {width,height} = page.getSize();
      const left=50, right=width-50;
      let y=height-50;

      // Report title
      const rptTxt = isComb?'Combined Report':isRev?'Revenues Report':'Expenses Report';
      page.drawText(rptTxt,{x:left,y,font:ub,size:18});
      y-=25;

      // Event details
      page.drawText('Event Details',{x:left,y,font:ub,size:16});
      y-=30;
      page.drawText(`Name: ${currentRecord.Name}`,{x:left,y,font:uf,size:12});
      y-=20;
      const evtFields=[
        `Code: ${currentRecord.EventCode||'N/A'}`,
        `Sport: ${currentRecord.Sport||'N/A'}`,
        `Discipline: ${currentRecord.Discipline||'N/A'}`,
        `Dates: ${formatDate(currentRecord.DateStart)} – ${formatDate(currentRecord.DateEnd)}`,
        `City: ${currentRecord.CITY||'N/A'}`,
        `Venue: ${currentRecord.VENUE||'N/A'}`,
        `Level: ${currentRecord.LEVEL||'N/A'}`
      ];
      const colW=(right-left)/3;
      evtFields.forEach((f,i)=>{
        const col=i%3, row=Math.floor(i/3);
        const x=left+col*colW, yPos=y-row*18;
        page.drawText(f,{x,y:yPos,font:uf,size:12});
      });
      y -= Math.ceil(evtFields.length/3)*18 + 10;

      // buildSection closure
      const buildSection = (hdrs, dts, cats, refField, label)=>{
        if (!hdrs.length) return;
        // page break between Exp & Rev
        if (isComb && label==='Revenues') {
          page = pdfDoc.addPage();
          y = height-50;
        }
        let sectTotal=0;
        hdrs.forEach(h=>{
          if (y<150) { page=pdfDoc.addPage(); y=height-50; }
          const cat=cats.find(c=>c.id===h.Category);
          const catName=cat?cat.Name:'No Category';
          const desc=h.Description?` > ${h.Description}`:'';
          const titleLine=catName+desc;
          page.drawText(titleLine,{x:left,y,font:ub,size:14});
          y-=20;
          const lines=dts.filter(d=>{
            const r=d[refField], id=Array.isArray(r)?r[1]:r;
            return id===h.id;
          });
          let sum=0;
          lines.forEach(d=>{
            if (y<150){ page=pdfDoc.addPage(); y=height-50; }
            page.drawText(d.Description||'',{x:left+20,y,font:uf,size:11});
            const val=d.Budget||d.Amount||0, txt=formatCurrency(val);
            page.drawText(txt,{
              x:right-uf.widthOfTextAtSize(txt,11),y,font:uf,size:11
            });
            // thin line under detail
            if (enablePdfDetailLines) {
              page.drawLine({
                start:{x:left+20,y:y-2},
                end:  {x:right,y:y-2},
                thickness:pdfDetailLineWidth,
                color:pdfDetailLineColor
              });
            }
            y-=16; sum+=val;
          });
          if (y<150){ page=pdfDoc.addPage(); y=height-50; }
          const sumTxt=formatCurrency(sum);
          page.drawText('Group Total:',{
            x:right-80-ub.widthOfTextAtSize(sumTxt,12),y,font:ub,size:12
          });
          page.drawText(sumTxt,{
            x:right-ub.widthOfTextAtSize(sumTxt,12),y,font:ub,size:12
          });
          y-=24; sectTotal+=sum;
        });
        if (y<150){ page=pdfDoc.addPage(); y=height-50; }
        const lbl=`TOTAL ${label.toUpperCase()}: ${formatCurrency(sectTotal)}`;
        page.drawText(lbl,{
          x:right-ub.widthOfTextAtSize(lbl,14),y,font:ub,size:14
        });
      };

      // Expenses
      const expHdrs = allExpenses.filter(h=>{
        const r=h.Event; return Array.isArray(r)?r[1]===currentRecord.id:r===currentRecord.id;
      });
      buildSection(expHdrs, allExpenseDetails, allExpenseCats, 'Expense','Expenses');

      // Revenues
      const revHdrs = allRevenues.filter(h=>{
        const r=h.Event; return Array.isArray(r)?r[1]===currentRecord.id:r===currentRecord.id;
      });
      if (isRev||isComb) buildSection(revHdrs, allRevenueDetails, allRevenueCats,'Revenue','Revenues');

      // Footer & page numbers
      const pages = pdfDoc.getPages();
      const ts = new Date().toLocaleString('el-GR');
      pages.forEach((pg,i)=>{
        pg.drawText(`Date: ${ts}`,{x:50,y:20,font:uf,size:8});
        pg.drawText('Generated by RapidShade Widget',{x:170,y:20,font:uf,size:8});
        const pn=`Page ${i+1} of ${pages.length}`;
        const {width} = pg.getSize();
        pg.drawText(pn,{
          x:width-50-uf.widthOfTextAtSize(pn,8),y:20,font:uf,size:8
        });
      });

      // Save & download
      const pdfBytes = await pdfDoc.save();
      const blob     = new Blob([pdfBytes],{type:'application/pdf'});
      const url      = URL.createObjectURL(blob);
      const a        = document.createElement('a');
      a.href     = url;
      a.download = `${currentRecord.Name}_${isComb?'Combined':(isRev?'Revenues':'Expenses')}.pdf`;
      a.click();
      URL.revokeObjectURL(url);

    } catch (err) {
      console.error("PDF gen error:", err);
      recordInfoElement.textContent = 'Error generating PDF. Check console.';
    } finally {
      downloadPdfButton.disabled   = false;
      downloadPdfButton.textContent = 'Download PDF Report';
    }
  }

  // Initialization: add any additional Events columns as needed
  grist.ready({
    requiredAccess: 'full',
    columns: [
      'EventCode','Name','Sport','Discipline','DateStart','DateEnd',
      'PERIF_CITY','CITY','VENUE','LEVEL','POOL_SIZE','Organiser'
      // ,'CustomField1','CustomField2',…
    ]
  });
  fetchData();
  grist.onRecord(onRecordUpdate);

</script>
</body>
</html>
