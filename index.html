<!DOCTYPE html>
<html>
<head>
  <title>Event PDF Budget & Revenue Report Widget</title>
  <meta charset="utf-8">
  <style>
    /* ================== EXISTING CSS ================== */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu,
                   Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      color: #333;
      margin: 0;
      padding: 20px;
      background-color: #f8f8f8;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      box-sizing: border-box;
      text-align: center;
    }
    .container {
      text-align: left;
      background-color: #fff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      max-width: 800px;
      width: 100%;
    }
    h2 {
      color: #2c3e50;
      margin-bottom: 20px;
      text-align: center;
    }
    p {
      font-size: 1em;
      color: #666;
      margin-bottom: 25px;
      text-align: center;
    }
    .button-container {
      text-align: center;
      width: 100%;
    }
    button {
      background-color: #4CAF50;
      color: white;
      padding: 12px 25px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1.1em;
      transition: background-color 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin: 5px;
    }
    button:hover { background-color: #45a049; }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
    input[type="radio"] { margin-right: 5px; }
    label { margin-right: 15px; font-size: 0.95em; color: #555; }
    #record-info { margin-top: 15px; font-size: 0.9em; color: #555; min-height: 20px; text-align: center; }
    .error-message { color: red; background: #ffe0e0; border: 1px solid red; padding: 10px; margin-top: 20px; border-radius: 5px; }
    #report-container { margin-top: 30px; text-align: left; }
    .event-details { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #e9ecef; }
    .event-details h3 { color: #2c3e50; margin-bottom: 15px; }
    .event-details-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr)); /* 2-column split */
      gap: 10px;
    }
    .detail-item { font-size: 0.95em; }
    .detail-item.full-width { grid-column: 1 / -1; }
    .detail-item strong { color: #495057; }
    .expense-group, .revenue-group { margin-bottom: 20px; }
    .expense-group h3, .revenue-group h3 {
      background-color: #e9ecef; padding: 10px; border-radius: 4px;
      color: #495057; margin: 0 0 10px 0;
    }
    .expense-item, .revenue-item, .group-summary {
      display: flex; justify-content: space-between;
      padding: 8px 10px; border-bottom: 1px solid #dee2e6;
    }
    .group-summary {
      font-weight: bold; background-color: #f8f9fa;
      border-top: 2px solid #dee2e6; margin-top: 5px;
    }
    .grand-total {
      display: flex; justify-content: space-between;
      padding: 12px 10px; margin-top: 20px;
      background-color: #2c3e50; color: white;
      font-weight: bold; font-size: 1.2em; border-radius: 4px;
    }
    .expense-item:last-child, .revenue-item:last-child { border-bottom: none; }
  </style>

  <!-- pdf-lib and fontkit for PDF generation -->
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://unpkg.com/@pdf-lib/fontkit/dist/fontkit.umd.min.js"></script>
  <!-- Grist Plugin API -->
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
</head>
<body>
  <div class="container" id="widget-container">
    <h2>Event PDF Report</h2>
    <p id="message">Connecting to Grist... Please select an event record.</p>
    <div class="button-container">
      <!-- REPORT TYPE SELECTOR -->
      <label><input type="radio" name="reportType" value="expenses" checked>Expenses</label>
      <label><input type="radio" name="reportType" value="revenues">Revenues</label>
      <label><input type="radio" name="reportType" value="combined">Combined</label>
      <button id="downloadPdfButton" disabled>Download PDF Report</button>
    </div>
    <div id="record-info"></div>
    <div id="report-container"></div>
  </div>

  <script>
    console.log("RapidShade: [WIDGET] v8.3 ▶️ Section sub-headers & 2-column Event layout");

    // Section headers mappings, easily changeable
    const SECTION_HEADERS = {
      expenses: 'Expenses Section',
      revenues: 'Revenues Section'
    };

    // PDF detail‐line configuration
    const enablePdfDetailLines = true;
    const pdfDetailLineWidth   = 0.5;
    const pdfDetailLineColor   = PDFLib.rgb(0.75,0.75,0.75);

    const { PDFDocument } = PDFLib;
    let currentRecord;
    let allExpenses = [], allExpenseDetails = [], allExpenseCats = [];
    let allRevenues = [], allRevenueDetails = [], allRevenueCats = [];

    // Helpers
    const fmtCurr = amt => (amt||0).toLocaleString('el-GR',{style:'currency',currency:'EUR'});
    const fmtDate = sec => {
      if (!sec) return 'N/A';
      const d = sec instanceof Date ? sec : new Date(sec*1000);
      return isNaN(d) ? 'Invalid Date' : d.toLocaleDateString('el-GR');
    };
    const toRecs  = data => {
      if (!data || typeof data !== 'object' || Array.isArray(data)) return Array.isArray(data)?data:[];
      const cols = Object.keys(data);
      if (!cols.length || !Array.isArray(data[cols[0]])) return [];
      const n = data[cols[0]].length, out = [];
      for (let i=0; i<n; i++){
        const r = {};
        for (let c of cols) r[c] = data[c][i];
        out.push(r);
      }
      return out;
    };

    // Fetch all tables
    async function fetchData(){
      try {
        const [er, ed, ec, rr, rd, rc] = await Promise.all([
          grist.docApi.fetchTable('Expenses'),
          grist.docApi.fetchTable('ExpenseDetails'),
          grist.docApi.fetchTable('ExpenseCategories'),
          grist.docApi.fetchTable('Revenues'),
          grist.docApi.fetchTable('RevenueDetails'),
          grist.docApi.fetchTable('RevenueCategories'),
        ]);
        allExpenses       = toRecs(er);
        allExpenseDetails = toRecs(ed);
        allExpenseCats    = toRecs(ec);
        allRevenues       = toRecs(rr);
        allRevenueDetails = toRecs(rd);
        allRevenueCats    = toRecs(rc);
      } catch(err) {
        console.error("Error fetching data:", err);
        document.getElementById('report-container').innerHTML = 
          '<div class="error-message">Error fetching tables. Check access.</div>';
      }
    }

    // Handle record selection
    function onRecordUpdate(rec){
      currentRecord = rec;
      const btn = document.getElementById('downloadPdfButton');
      if(rec && Object.keys(rec).length){
        document.getElementById('message').style.display = 'none';
        btn.disabled = false;
        document.getElementById('record-info').textContent = `Selected: ${rec.Name}`;
        renderHtmlReport();
      } else {
        document.getElementById('message').style.display = 'block';
        btn.disabled = true;
        document.getElementById('record-info').textContent = '';
        document.getElementById('report-container').innerHTML = '';
      }
    }

    // Render the on-screen preview
    function renderHtmlReport(){
      const container = document.getElementById('report-container');
      container.innerHTML = '';
      if (!currentRecord) return;

      // Main heading
      const rpt = document.querySelector('input[name=reportType]:checked').value;
      const title = rpt==='combined' ? 'Combined Report'
                   : rpt==='revenues'? 'Revenues Report'
                                     : 'Expenses Report';
      container.appendChild(Object.assign(document.createElement('h3'),{textContent:title}));

      // Event Details: Name full‐width, others in 2‐column grid
      const ev = document.createElement('div');
      ev.className = 'event-details';
      ev.innerHTML = `
        <h3>Event Details</h3>
        <div class="detail-item full-width"><strong>Name:</strong> ${currentRecord.Name||'N/A'}</div>
        <div class="event-details-grid">
          <div class="detail-item"><strong>Code:</strong> ${currentRecord.EventCode||'N/A'}</div>
          <div class="detail-item"><strong>Sport:</strong> ${currentRecord.Sport||'N/A'}</div>
          <div class="detail-item"><strong>Discipline:</strong> ${currentRecord.Discipline||'N/A'}</div>
          <div class="detail-item"><strong>Dates:</strong> ${fmtDate(currentRecord.DateStart)} – ${fmtDate(currentRecord.DateEnd)}</div>
          <div class="detail-item"><strong>City:</strong> ${currentRecord.CITY||'N/A'}</div>
          <div class="detail-item"><strong>Venue:</strong> ${currentRecord.VENUE||'N/A'}</div>
          <div class="detail-item"><strong>Level:</strong> ${currentRecord.LEVEL||'N/A'}</div>
        </div>`;
      container.appendChild(ev);

      // Expenses section
      if ((rpt==='expenses' || rpt==='combined') && allExpenses.length) {
        container.appendChild(Object.assign(document.createElement('h3'),{textContent:SECTION_HEADERS.expenses}));
        renderGroups(container, allExpenses, allExpenseDetails, allExpenseCats, 'Expense');
      }

      // Revenues section
      if ((rpt==='revenues' || rpt==='combined') && allRevenues.length) {
        container.appendChild(Object.assign(document.createElement('h3'),{textContent:SECTION_HEADERS.revenues}));
        renderGroups(container, allRevenues, allRevenueDetails, allRevenueCats, 'Revenue');
      }

      // No records?
      if ((rpt==='expenses' && !allExpenses.length)
       ||(rpt==='revenues' && !allRevenues.length)
       ||(rpt==='combined' && !allExpenses.length && !allRevenues.length)) {
        container.appendChild(Object.assign(document.createElement('p'),{textContent:'No records to display.'}));
      }
    }

    // Render a grouped section in HTML
    function renderGroups(container, headers, details, cats, refField){
      let grand=0;
      const filtered = headers.filter(h=>{
        const r=h.Event; return Array.isArray(r)?r[1]===currentRecord.id:r===currentRecord.id;
      });
      filtered.forEach(h=>{
        const cat = cats.find(c=>c.id===h.Category);
        const title = (cat?cat.Name:'No Category') + (h.Description?` > ${h.Description}`:'');
        const gDiv = document.createElement('div');
        gDiv.className = refField.toLowerCase()+'-group';
        gDiv.innerHTML = `<h3>${title}</h3>`;
        let sum=0;
        details.filter(d=>{
          const r=d[refField], id=Array.isArray(r)?r[1]:r;
          return id===h.id;
        }).forEach(d=>{
          const val=d.Budget||d.Amount||0;
          sum+=val;
          const li = document.createElement('div');
          li.className = refField.toLowerCase()+'-item';
          li.innerHTML = `<span>${d.Description||''}</span><span>${fmtCurr(val)}</span>`;
          gDiv.appendChild(li);
        });
        const sg = document.createElement('div');
        sg.className = 'group-summary';
        sg.innerHTML = `<span>Group Total</span><span>${fmtCurr(sum)}</span>`;
        gDiv.appendChild(sg);
        container.appendChild(gDiv);
        grand+=sum;
      });
      const gt = document.createElement('div');
      gt.className = 'grand-total';
      gt.innerHTML = `<span>GRAND TOTAL ${refField.toUpperCase()}</span><span>${fmtCurr(grand)}</span>`;
      container.appendChild(gt);
    }

    // Live UI updates
    document.querySelectorAll('input[name=reportType]')
      .forEach(radio=>radio.addEventListener('change', renderHtmlReport));
    document.getElementById('downloadPdfButton')
      .addEventListener('click', onDownloadClick);

    // Download / generate PDF
    async function onDownloadClick(){
      const rpt = document.querySelector('input[name=reportType]:checked').value;
      if (rpt==='expenses')      await pdfReport(false,false);
      else if (rpt==='revenues') await pdfReport(true ,false);
      else                        await pdfReport(false,true );
    }

    // Core PDF creation
    async function pdfReport(isRev,isComb){
      const btn = document.getElementById('downloadPdfButton');
      btn.disabled = true;
      btn.textContent = 'Generating...';
      try {
        const pdf = await PDFDocument.create();
        pdf.registerFontkit(fontkit);
        const [rBuf,bBuf] = await Promise.all([
          fetch('https://pdf-lib.js.org/assets/ubuntu/Ubuntu-R.ttf').then(r=>r.arrayBuffer()),
          fetch('https://pdf-lib.js.org/assets/ubuntu/Ubuntu-B.ttf').then(r=>r.arrayBuffer())
        ]);
        const uf = await pdf.embedFont(rBuf), ub = await pdf.embedFont(bBuf);

        // Pagination / layout vars
        let page = pdf.addPage();
        const {width, height} = page.getSize();
        const left = 50, right = width-50;
        let y = height-50;

        // Report Title
        const rptTxt = isComb ? 'Combined Report'
                     : isRev  ? 'Revenues Report'
                              : 'Expenses Report';
        page.drawText(rptTxt, { x:left, y, font:ub, size:18 });
        y -= 25;

        // Event Details
        page.drawText('Event Details', { x:left, y, font:ub, size:16 });
        y -= 30;
        page.drawText(`Name: ${currentRecord.Name}`, { x:left, y, font:uf, size:12 });
        y -= 20;
        const evFields = [
          `Code: ${currentRecord.EventCode||'N/A'}`,
          `Sport: ${currentRecord.Sport||'N/A'}`,
          `Discipline: ${currentRecord.Discipline||'N/A'}`,
          `Dates: ${fmtDate(currentRecord.DateStart)} – ${fmtDate(currentRecord.DateEnd)}`,
          `City: ${currentRecord.CITY||'N/A'}`,
          `Venue: ${currentRecord.VENUE||'N/A'}`,
          `Level: ${currentRecord.LEVEL||'N/A'}`
        ];
        const colW = (right-left)/2;
        evFields.forEach((f,i)=>{
          const col = i%2, row = Math.floor(i/2);
          const x = left + col*colW, yy = y - row*18;
          page.drawText(f, { x, y:yy, font:uf, size:12 });
        });
        y -= Math.ceil(evFields.length/2)*18 + 10;

        // Section builder closure
        const buildSection = (hdrs, dts, cats, refF, key) => {
          const recs = hdrs.filter(h=>{
            const r = h.Event; return Array.isArray(r)?r[1]===currentRecord.id:r===currentRecord.id;
          });
          if (!recs.length) return;
          // In combined, start revenues on new page
          if (isComb && key==='revenues') {
            page = pdf.addPage(); y = height-50;
          }
          // Section sub-header
          page.drawText(SECTION_HEADERS[key], { x:left, y, font:ub, size:16 });
          y -= 25;
          let sectionTotal = 0;
          recs.forEach(h => {
            if (y < 150) { page = pdf.addPage(); y = height-50; }
            const cat = cats.find(c=>c.id===h.Category);
            const head = (cat?cat.Name:'No Category') + (h.Description?` > ${h.Description}`:'');
            page.drawText(head, { x:left, y, font:ub, size:14 });
            y -= 20;

            let grpSum = 0;
            dts.filter(d => {
              const r = d[refF]; return Array.isArray(r)?r[1]===h.id:r===h.id;
            }).forEach(d => {
              if (y < 150) { page = pdf.addPage(); y = height-50; }
              page.drawText(d.Description||'', { x:left+20, y, font:uf, size:11 });
              const val = d.Budget||d.Amount||0, txt = fmtCurr(val);
              page.drawText(txt, {
                x: right - uf.widthOfTextAtSize(txt,11),
                y, font:uf, size:11
              });
              // thin detail line
              if (enablePdfDetailLines) {
                page.drawLine({
                  start: { x:left+20, y:y-2 },
                  end:   { x:right,    y:y-2 },
                  thickness: pdfDetailLineWidth,
                  color: pdfDetailLineColor
                });
              }
              y -= 16;
              grpSum += val;
            });

            if (y < 150) { page = pdf.addPage(); y = height-50; }
            const sumTxt = fmtCurr(grpSum);
            page.drawText('Group Total:', {
              x: right - 80 - ub.widthOfTextAtSize(sumTxt,12),
              y, font:ub, size:12
            });
            page.drawText(sumTxt, {
              x: right - ub.widthOfTextAtSize(sumTxt,12),
              y, font:ub, size:12
            });
            y -= 24;
            sectionTotal += grpSum;
          });

          if (y < 150) { page = pdf.addPage(); y = height-50; }
          const sectionTxt = `TOTAL ${key.toUpperCase()}: ${fmtCurr(sectionTotal)}`;
          page.drawText(sectionTxt, {
            x: right - ub.widthOfTextAtSize(sectionTxt,14),
            y, font:ub, size:14
          });
        };

        // Build expenses & revenues
        buildSection(allExpenses, allExpenseDetails, allExpenseCats, 'Expense', 'expenses');
        buildSection(allRevenues, allRevenueDetails, allRevenueCats, 'Revenue', 'revenues');

        // Footer & pagination
        const pages = pdf.getPages();
        const ts = new Date().toLocaleString('el-GR');
        pages.forEach((pg,i)=>{
          pg.drawText(`Date: ${ts}`, { x:50, y:20, font:uf, size:8 });
          pg.drawText('Generated by RapidShade Widget', { x:170, y:20, font:uf, size:8 });
          const pnum = `Page ${i+1} of ${pages.length}`;
          pg.drawText(pnum, {
            x: pg.getWidth() - 50 - uf.widthOfTextAtSize(pnum,8),
            y: 20, font:uf, size:8
          });
        });

        // Save and download
        const pdfBytes = await pdf.save();
        const blob = new Blob([pdfBytes], { type:'application/pdf' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${currentRecord.Name}_${isComb?'Combined':(isRev?'Revenues':'Expenses')}.pdf`;
        a.click();
        URL.revokeObjectURL(url);

      } catch(err) {
        console.error("PDF gen error:", err);
        document.getElementById('record-info').textContent = 'Error generating PDF.';
      } finally {
        const btn = document.getElementById('downloadPdfButton');
        btn.disabled = false;
        btn.textContent = 'Download PDF Report';
      }
    }

    // Initialize plugin, request all event fields
    grist.ready({
      requiredAccess: 'full',
      columns: [
        'EventCode','Name','Sport','Discipline','DateStart','DateEnd',
        'PERIF_CITY','CITY','VENUE','LEVEL','POOL_SIZE','Organiser'
      ]
    });

    fetchData();
    grist.onRecord(onRecordUpdate);
  </script>
</body>
</html>
