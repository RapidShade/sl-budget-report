<!DOCTYPE html>
<html>
<head>
    <title>Event PDF Budget Report Widget</title>
    <meta charset="utf-8">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            color: #333;
            margin: 0;
            padding: 20px;
            background-color: #f8f8f8;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            box-sizing: border-box;
            text-align: center;
        }
        .container {
            text-align: center;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
        }
        h2 {
            color: #2c3e50;
            margin-bottom: 20px;
        }
        p {
            font-size: 1em;
            color: #666;
            margin-bottom: 25px;
        }
        button {
            background-color: #4CAF50; /* Grist-like green */
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        #record-info {
            margin-top: 15px;
            font-size: 0.9em;
            color: #555;
            min-height: 20px; /* To prevent layout shift */
        }
        .error-message {
            color: red;
            background-color: #ffe0e0;
            border: 1px solid red;
            padding: 10px;
            margin-top: 20px;
            border-radius: 5px;
        }
    </style>
    <!-- Load pdf-lib and its fontkit extension -->
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit/dist/fontkit.umd.min.js"></script>
    <!-- This is the Grist plugin API script provided in your original file -->
    <script src="https://sportsledger.koe.org.gr/grist-plugin-api.js"></script>
</head>
<body>
    <div class="container" id="widget-container">
        <h2>Event PDF Budget Report</h2>
        <p id="message">Connecting to Grist... Please select a record.</p>
        <button id="downloadPdfButton" style="display: none;" disabled>Download PDF Report</button>
        <button id="debugButton" disabled>Debug Record Fetch</button>
        <div id="record-info"></div>
    </div>

    
<script>
(async function init() {
  const { PDFDocument, StandardFonts } = window.pdfLib;
  let currentRecord = null;
  let expenseGroups = [];

  const status = document.getElementById("status");
  const button = document.getElementById("btn");

  grist.ready();
  grist.onRecord((rec) => {
    currentRecord = rec;
    status.textContent = rec?.Name ? `Ready: ${rec.Name}` : "Select an event";
    button.disabled = !rec?.Name;
  });

  grist.onRecords((records) => {
    if (!Array.isArray(records)) return;
    expenseGroups = [];
    const groups = {};
    for (const r of records) {
      if (r.Event.id !== currentRecord.id) continue;
      const groupName = r.ExpenseCategory?.GroupName || "Other";
      const order = r.ExpenseCategory?.DisplayOrder || 9999;
      if (!groups[groupName]) {
        groups[groupName] = { groupName, order, items: [] };
      }
      groups[groupName].items.push({
        name: r.ExpenseCategory?.Name || "(Unknown)",
        amount: r.Amount || 0,
        notes: r.Notes || ""
      });
    }
    expenseGroups = Object.values(groups).sort((a, b) => a.order - b.order);
  });

  button.addEventListener("click", async () => {
    if (!currentRecord) return alert("No event selected");

    const pdfDoc = await PDFDocument.create();
    const page = pdfDoc.addPage();
    const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
    const { width, height } = page.getSize();

    const drawLine = (text, x, y, size = 12) => {
      page.drawText(text, { x, y, size, font });
    };

    let y = height - 40;
    drawLine("Event Budget Report", 50, y, 16); y -= 30;
    const fields = [
      ["Event Code", currentRecord.EventCode],
      ["Name", currentRecord.Name],
      ["Sport", currentRecord.Sport],
      ["Discipline", currentRecord.Discipline],
      ["Start Date", currentRecord.DateStart],
      ["End Date", currentRecord.DateEnd],
      ["City", currentRecord.CITY],
      ["Venue", currentRecord.VENUE],
      ["Level", currentRecord.LEVEL],
      ["Pool Size", currentRecord.POOL_SIZE],
      ["Organiser", currentRecord.Organiser]
    ];
    for (const [label, value] of fields) {
      drawLine(`${label}: ${value || ""}`, 50, y); y -= 20;
    }

    y -= 10;
    drawLine("Expenses by Group", 50, y, 14); y -= 25;
    for (const group of expenseGroups) {
      drawLine(`${group.groupName}`, 50, y, 13); y -= 18;
      for (const item of group.items) {
        drawLine(`- ${item.name}: ${item.amount} (${item.notes})`, 60, y); y -= 16;
        if (y < 50) {
          page = pdfDoc.addPage();
          y = height - 40;
        }
      }
      y -= 10;
    }

    const pdfBytes = await pdfDoc.save();
    const blob = new Blob([pdfBytes], { type: "application/pdf" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `BudgetReport_${currentRecord.EventCode || "event"}.pdf`;
    a.click();
    URL.revokeObjectURL(url);
  });
})();
</script>

</body>
</html>
