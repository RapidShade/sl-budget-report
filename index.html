<!DOCTYPE html>
<html>
<head>
    <title>Event PDF Budget Report Widget</title>
    <meta charset="utf-8">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            color: #333;
            margin: 0;
            padding: 20px;
            background-color: #f8f8f8;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            box-sizing: border-box;
            text-align: center;
        }
        .container {
            text-align: center;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
        }
        h2 {
            color: #2c3e50;
            margin-bottom: 20px;
        }
        p {
            font-size: 1em;
            color: #666;
            margin-bottom: 25px;
        }
        button {
            background-color: #4CAF50; /* Grist-like green */
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        #record-info {
            margin-top: 15px;
            font-size: 0.9em;
            color: #555;
            min-height: 20px; /* To prevent layout shift */
        }
        .error-message {
            color: red;
            background-color: #ffe0e0;
            border: 1px solid red;
            padding: 10px;
            margin-top: 20px;
            border-radius: 5px;
        }
        #report-container {
            margin-top: 30px;
            text-align: left;
        }
        .expense-group {
            margin-bottom: 20px;
        }
        .expense-group h3 {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            color: #495057;
            margin: 0 0 10px 0;
        }
        .expense-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 10px;
            border-bottom: 1px solid #dee2e6;
        }
        .expense-item:last-child {
            border-bottom: none;
        }
    </style>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit/dist/fontkit.umd.min.js"></script>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
</head>
<body>
    <div class="container" id="widget-container">
        <h2>Event PDF Budget Report</h2>
        <p id="message">Connecting to Grist... Please select a record.</p>
        <button id="downloadPdfButton" style="display: none;" disabled>Download PDF Report</button>
        <div id="record-info"></div>
        <div id="report-container"></div>
    </div>

    <script>
        console.log("[WIDGET] v5.2 Starting");

        if (typeof PDFLib === 'undefined' || typeof fontkit === 'undefined') {
            document.getElementById('widget-container').innerHTML = '<div class="error-message">Error: PDF Libraries not loaded.</div>';
            throw new Error("PDF-Lib or fontkit not found.");
        }

        const { PDFDocument, rgb } = PDFLib;
        const messageElement = document.getElementById('message');
        const downloadPdfButton = document.getElementById('downloadPdfButton');
        const recordInfoElement = document.getElementById('record-info');
        const reportContainer = document.getElementById('report-container');
        let currentRecord = null;
        let expensesData = [];
        let expenseCategoriesData = [];

        async function updateUI(record) {
            currentRecord = record;
            if (record && Object.keys(record).length > 0) {
                console.log("[WIDGET] Record selected:", record);
                messageElement.style.display = 'none';
                downloadPdfButton.style.display = 'inline-block';
                downloadPdfButton.disabled = false;
                recordInfoElement.textContent = `Selected: ${record.Name || record.EventCode || 'Unnamed Event'}`;
                await fetchDataAndRenderReport();
            } else {
                console.log("[WIDGET] No record selected.");
                currentRecord = null;
                messageElement.style.display = 'block';
                messageElement.textContent = "Please select a record in the table.";
                downloadPdfButton.style.display = 'none';
                downloadPdfButton.disabled = true;
                recordInfoElement.textContent = '';
                reportContainer.innerHTML = '';
            }
        }

        async function fetchDataAndRenderReport() {
            if (!currentRecord) return;

            try {
                expensesData = await grist.docApi.fetchTable('Expenses');
                // Corrected table name from 'ExpenseCategory' to 'ExpenseCategories'
                expenseCategoriesData = await grist.docApi.fetchTable('ExpenseCategories');
                renderReport();
            } catch (error) {
                console.error("Error fetching data:", error);
                reportContainer.innerHTML = `<div class="error-message">Error fetching expense data. Make sure 'Expenses' and 'ExpenseCategories' tables exist.</div>`;
            }
        }

        function renderReport() {
            reportContainer.innerHTML = ''; // Clear previous report
            if (!currentRecord || expensesData.length === 0 || expenseCategoriesData.length === 0) {
                return;
            }

            const eventExpenses = expensesData.filter(e => e.Event === currentRecord.id);

            const categoryMap = new Map(expenseCategoriesData.map(c => [c.id, c]));

            const groupedExpenses = eventExpenses.reduce((acc, expense) => {
                const category = categoryMap.get(expense.Category);
                if (category) {
                    const groupName = category.Name || 'Uncategorized';
                    if (!acc[groupName]) {
                        acc[groupName] = {
                            items: [],
                            displayOrder: category.manualSort || 999
                        };
                    }
                    acc[groupName].items.push({
                        description: expense.Notes,
                        amount: expense.Budget
                    });
                }
                return acc;
            }, {});

            const sortedGroups = Object.entries(groupedExpenses).sort(([, a], [, b]) => a.displayOrder - b.displayOrder);

            for (const [groupName, groupData] of sortedGroups) {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'expense-group';
                
                const title = document.createElement('h3');
                title.textContent = groupName;
                groupDiv.appendChild(title);

                for (const item of groupData.items) {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'expense-item';
                    itemDiv.innerHTML = `<span>${item.description}</span><span>${item.amount.toLocaleString('el-GR', { style: 'currency', currency: 'EUR' })}</span>`;
                    groupDiv.appendChild(itemDiv);
                }
                reportContainer.appendChild(groupDiv);
            }
        }

        function formatDate(dateInput) {
            if (!dateInput) return 'N/A';
            const date = new Date(dateInput * 1000);
            if (isNaN(date.getTime())) return 'Invalid Date';
            return date.toISOString().split('T')[0];
        }

        async function generatePdfReport() {
            if (!currentRecord) {
                alert("Please select a record first.");
                return;
            }

            downloadPdfButton.disabled = true;
            downloadPdfButton.textContent = 'Generating...';

            try {
                const fontUrl = 'https://pdf-lib.js.org/assets/ubuntu/Ubuntu-R.ttf';
                const boldFontUrl = 'https://pdf-lib.js.org/assets/ubuntu/Ubuntu-B.ttf';

                const [fontBytes, boldFontBytes] = await Promise.all([
                    fetch(fontUrl).then(res => res.arrayBuffer()),
                    fetch(boldFontUrl).then(res => res.arrayBuffer())
                ]);

                const pdfDoc = await PDFDocument.create();
                pdfDoc.registerFontkit(fontkit);
                const customFont = await pdfDoc.embedFont(fontBytes);
                const customBoldFont = await pdfDoc.embedFont(boldFontBytes);

                let page = pdfDoc.addPage();
                let y = 750;
                const x = 50;
                const lineHeight = 18;

                page.drawText('Event Budget Report', { x, y, font: customBoldFont, size: 24, color: rgb(0.1, 0.1, 0.1) });
                y -= 40;

                const addDetail = (label, value) => {
                    if (y < 50) {
                        page = pdfDoc.addPage();
                        y = 780;
                    }
                    page.drawText(`${label}: `, { x, y, font: customBoldFont, size: 12 });
                    const labelWidth = customBoldFont.widthOfTextAtSize(`${label}: `, 12);
                    page.drawText(String(value || 'N/A'), { x: x + labelWidth + 2, y, font: customFont, size: 12 });
                    y -= lineHeight;
                };
                
                // Event Details
                const { Name, DateStart, DateEnd, CITY, VENUE } = currentRecord;
                addDetail('Event', Name);
                addDetail('Dates', `${formatDate(DateStart)} to ${formatDate(DateEnd)}`);
                addDetail('Location', `${CITY}, ${VENUE}`);
                y -= 20;

                // Expenses
                const eventExpenses = expensesData.filter(e => e.Event === currentRecord.id);
                const categoryMap = new Map(expenseCategoriesData.map(c => [c.id, c]));
                const groupedExpenses = eventExpenses.reduce((acc, expense) => {
                    const category = categoryMap.get(expense.Category);
                    if (category) {
                        const groupName = category.Name || 'Uncategorized';
                        if (!acc[groupName]) {
                            acc[groupName] = { items: [], displayOrder: category.manualSort || 999 };
                        }
                        acc[groupName].items.push({ description: expense.Notes, amount: expense.Budget });
                    }
                    return acc;
                }, {});

                const sortedGroups = Object.entries(groupedExpenses).sort(([, a], [, b]) => a.displayOrder - b.displayOrder);

                for (const [groupName, groupData] of sortedGroups) {
                    if (y < 60) {
                        page = pdfDoc.addPage();
                        y = 780;
                    }
                    page.drawText(groupName, { x, y, font: customBoldFont, size: 14, color: rgb(0.2, 0.2, 0.2) });
                    y -= 25;

                    for (const item of groupData.items) {
                        if (y < 40) {
                            page = pdfDoc.addPage();
                            y = 780;
                        }
                        page.drawText(item.description, { x: x + 10, y, font: customFont, size: 10 });
                        const amountText = item.amount.toLocaleString('el-GR', { style: 'currency', currency: 'EUR' });
                        const textWidth = customFont.widthOfTextAtSize(amountText, 10);
                        page.drawText(amountText, { x: 500 - textWidth, y, font: customFont, size: 10 });
                        y -= 15;
                    }
                    y -= 10;
                }

                const pdfBytes = await pdfDoc.save();
                const filename = `Budget_Report_${currentRecord.Name || 'Event'}.pdf`;
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);

            } catch (error) {
                console.error("[WIDGET] Error generating PDF:", error);
                recordInfoElement.textContent = 'Error creating PDF. Check console.';
            } finally {
                downloadPdfButton.disabled = false;
                downloadPdfButton.textContent = 'Download PDF Report';
            }
        }

        grist.ready({ requiredAccess: 'full' });
        grist.onRecord(updateUI);

    </script>
</body>
</html>
